<!doctype html>
<html>
	<head>
		<title>Tectonics.js - 3d plate tectonics in your web browser</title>
		<!--If using IE9 or lower, don't even bother - IE won't even parse three.js right-->
		<!--[if lte IE 9]>
			<meta http-equiv="refresh" content="0;url=ie.html" />
		<![endif]-->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link  href="css/main.css" rel="stylesheet"/>
		<link  href="css/modern.css" rel="stylesheet"/>
		<link  href="css/app.css" rel="stylesheet"/>

		<script src="http://code.jquery.com/jquery.min.js"></script>
		<script src="vendor/three.js/Three.js"></script>
		<script src="vendor/three.js/Detector.js"></script>
		<!-- https://github.com/mrdoob/stats.js -->
		<script src="vendor/three.js/Stats.js"></script>
		<script src="vendor/three.js/OrbitControls.js"></script>
		<script src="vendor/threex/THREEx.screenshot.js"></script>
		<script src="vendor/threex/THREEx.FullScreen.js"></script>
		<script src="vendor/threex/THREEx.WindowResize.js"></script>
		<script src="vendor/jquery-1.10.2.min.js"></script>
		<script src="vendor/underscore-min.js"></script>
		<script src="vendor/buckets-minified.js"></script>
		<script src="RockColumn.js"></script>
		<script src="vendor/random-0.26.js"></script>
		<script src="vendor/kdTree-min.js"></script>
		<script src="Voronoi.js"></script>
		<script src="Grid.js"></script>
		<script src="Cell.js"></script>
		<script src="Plate.js"></script>
		<script src="Voronoi.js"></script>
		<script src="Grid.js"></script>
		<script src="Style.js"></script>
		<script src="View.js"></script>
		<script src="World.js"></script>
		<script src="Style.js"></script>
		<script src="Projection.js"></script>
		<script src="Cached.js"></script>
	</head>
<body>
	<!-- three.js container -->
	<div id="container"></div>
	<!-- info on screen display -->
	<div class="topright parameters">
		<table>
			<tr>
				<td>Age:</td>
				<td><span id="age">initializing...</span></td>
			</tr>
			<tr>
				<td>Speed:</td>
				<td>
					<input id="speedControl" type="number" value="5" min="0" max="10" step="1" style="width:30px" /> My/s
				</td>
			</tr>
			<tr>
				<td>View:</td>
				<td>
					<select id="fragmentShader">
						<option value="satellite" selected>Satellite Image</option>
						<option value="soil">Soil</option>
						<option value="bedrock">Bedrock</option>
						<option value="npp">Plant Productivity</option>
						<option value="temp">Temperature</option>
						<option value="precip">Precipitation</option>
						<option value="debug">Plates</option>
					</select>
				</td>
			</tr>
			<tr>
				<td>Projection:</td>
				<td>
					<select id="vertexShader">
						<option value="orthographic" selected>Orthographic</option>
						<option value="equirectangular">Equirectangular</option>
					</select>
				</td>
			</tr>
		</table>
		<div></div>
	</div>
	<div class="bottomright instructions">
		<ul>
			<li id="screenshotLabel" class="hidden"><i>p</i> for screenshot</li>
			<li id="fullscreenLabel" class="hidden"><i>f</i> for fullscreen</li>
		</ul>
	</div> 
	<div class="vcenter">
		<div id="noWebGl" class="hidden hcenter dialog">
			<h2>Well, darn</h2>
			<p>It looks like your using a web browser without WebGL.</p>
			<p>WebGL is a technology that allows users to run high-end 3d graphics from their web-browser. Other technologies exist that can display simple 3d graphics to the user (canvas, svg, flash, etc.), but at present WebGL is the only web technology that allows developers to send their own code to a GPU.
			</p>
			<p>Writing a tectonics simulator in a browser is hard stuff. We're going to need all the tools we can get.
			</p>
			<p>It looks like you're using a browser that supports WebGL, but you just need to modify some settings, first. <a href="http://get.webgl.org/">Here</a> is a link that will help you get started.
			</p>
			<p>Until then, here's a video of what you're missing:
			</p>
			<iframe width="420" height="315" src="//www.youtube.com/embed/VE67RgnLdKw" frameborder="0" allowfullscreen></iframe>
		</div>
		<div id="noJs" class="hcenter dialog">
			<h2>Might want to check your settings, there</h2>
			<p>It looks like your surfing the web without javascript enabled.</p>
			<p>Javascript is a fundamental component of the modern internet and there's no way a site like this can work without it. For instructions on how to enable javascript, check <a href="http://www.enable-javascript.com/">here</a>.</p>
		</div>
	</div> 
	
	<script type="text/javascript">
		$('#noJs').hide();
		//standards:
		// all points are vectors
		// all angles are in radians
		// all distance is in km
		// all thickness is in meters
		// all time in Million years (My)
		// all speeds are in km/My (goes along with distance)
		// all densities are in kg/m^3 (goes along with thickness)
		// planets are rendered as unit spheres
		
	    var querystring = [];
	    for(var i = 0, 
	    	hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&'); 
	    	i < hashes.length; i++)
	    {
	        var hash = hashes[i].split('=');
	        querystring.push(hash[0]);
	        querystring[hash[0]] = hash[1];
	    }

		var stats, renderer, clock, controls;
		var random = querystring['seed']? new Random(querystring['seed']) : new Random();
		var MegaYearPerSecond = 5 //My/second

		var world = new World(new Grid( new THREE.IcosahedronGeometry(1, 5), voronoiCache));
		var view = new View(world, fragmentShaders[$('#fragmentShader').val()], vertexShaders[$('#vertexShader').val()]);
		if( Detector.webgl ){
			if( !init() ) animate();
			$('#screenshotLabel').toggle();
		} else {
			$('#noWebGl').toggle();
		}

		// init the scene
		function init(){
			renderer = new THREE.WebGLRenderer({
				antialias		: true,	// to get smoother output
				preserveDrawingBuffer	: true	// to allow screenshot
			});
			renderer.setClearColor( 0x000000, 1 );
			renderer.setSize( window.innerWidth, window.innerHeight );
			$('#container').append(renderer.domElement);

			clock = new THREE.Clock();
			
			// add Stats.js - https://github.com/mrdoob/stats.js
			stats = new Stats();
			stats.domElement.style.position	= 'absolute';
			stats.domElement.style.bottom	= '0px';
			document.body.appendChild( stats.domElement );

			// create a camera contol
			controls	= new THREE.OrbitControls( view.camera, $("#container").get(0) );

			// transparently support window resize
			THREEx.WindowResize.bind(renderer, view.camera);
			// allow 'p' to make screenshot
			THREEx.Screenshot.bindKey(renderer);
			// allow 'f' to go fullscreen where this feature is supported
			if( THREEx.FullScreen.available() ){
				THREEx.FullScreen.bindKey();
				$('#fullscreenLabel').toggle();
			} 
		}
		
		function format(My, rollover, precision){
			var quantity = My * 1000000;
			var units = ['ky', 'My', 'By']
			var unit = 'yr';
			while(quantity > rollover) {
				unit = units.shift();
				quantity /= 1000;
			}
			return quantity.toPrecision(precision).toString() + " " + unit;
		}

		// animation loop
		function animate() {

			// loop on request animation loop
			// - it has to be at the begining of the function
			// - see details at http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
			
			var timestep = clock.getDelta();
			if (timestep > 1){
				timestep = 1;
			}
			
			requestAnimationFrame( animate );
			
			world.simulate(MegaYearPerSecond*timestep);
			
			view.update();
			$("#age").html(format(world.age, 1000, 3));
			// do the render
			render();

			// update stats
			stats.update();
		}

		// render the scene
		function render() {

			// update camera controls
			controls.update();


			// actually render the scene
			renderer.render( view.scene, view.camera );
		}
		
		$('#speedControl').change(function(e){
			MegaYearPerSecond = $('#speedControl').val();
		});
		$('#fragmentShader').change(function(e){
			view.fragmentShader(fragmentShaders[$('#fragmentShader').val()]);
		});
		$('#vertexShader').change(function(e){
			view.vertexShader(vertexShaders[$('#vertexShader').val()]);
		});
	</script>
</body>
</html>
