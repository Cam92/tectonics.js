<!doctype html>
<html>
<head>
	<title>solar system test model</title>
	<!--If using IE9 or lower, don't even bother - IE won't even parse three.js right-->
	<!--[if lte IE 9]>
		<meta http-equiv="refresh" content="0;url=ie.html" />
	<![endif]-->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	<link rel="icon" type="text/css" href="blog/icon4.png">
	<link rel="stylesheet" href="styles/bootstrap.min.css">
	<link rel="stylesheet" href="styles/bootstrap.custom.css">
	<link rel="stylesheet" href="styles/main.css"/>
	<link rel="stylesheet" href="styles/modern.css"/>
	<link rel="stylesheet" href="styles/app.css"/>

	<script src="http://code.jquery.com/jquery.min.js"></script>
	<script src="libraries/bootstrap.js"></script>
	<script src="libraries/three.js/Three.js"></script>
	<script src="libraries/three.js/Detector.js"></script>
	<script src="libraries/three.js/Stats.js"></script>
	<script src="libraries/three.js/OrbitControls.js"></script>
	<script src="libraries/three.js/BufferGeometryUtils.js"></script>
	<script src="libraries/three.js/ConvexGeometry.js"></script>
	<script src="libraries/threex/THREEx.screenshot.js"></script>
	<script src="libraries/threex/THREEx.FullScreen.js"></script>
	<script src="libraries/threex/THREEx.WindowResize.js"></script>
	<script src="libraries/threex/THREEx.Debug.js"></script>
	<script src="libraries/random-0.26.js"></script>
	<script src="postcompiled/utils/Rasters.js"></script>
	<script src="noncompiled/utils/Units.js"></script>
	<script src="noncompiled/academics/OrbitalMechanics.js"></script>
	<script src="noncompiled/model/universe/Orbit.js"></script>
	<script src="noncompiled/model/universe/Spin.js"></script>
	<script src="noncompiled/model/universe/System.js"></script>
	<script src="noncompiled/name-gen/NameGenerator.js"></script>
	<script src="noncompiled/name-gen/NameCorpii.js"></script>
</head>
<body>
<!-- three.js container -->
<div id="container"></div>
<script type="x-shader/x-vertex" id="particle-vertex-shader">
	varying vec3 vColor;
	varying vec3 vPosition;
	attribute float radius;
	attribute vec3 color;
    const float sun_radius = 695e6; //meters

	//USER_INPUT_GOES_HERE

	void main() {
		vPosition = position;
		vColor = color;
		gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.);
		gl_PointSize = 10. * log(radius)/log(sun_radius);
	}
</script>
<script type="x-shader/x-fragment" id="particle-fragment-shader">
    const float PI = 3.1415926;

    varying vec3 vPosition;
    varying vec3 vColor;

    //USER_INPUT_GOES_HERE

    void main() {
        gl_FragColor = vec4(vColor,1);
    }
</script> 
<!-- logo -->
<script type="text/javascript">
	'use strict';
	
	var scene, renderer, composer, clock;
	var camera, controls;
	var renderStats;

	var bodies = {
		sun: 	{ name: 'sun',		color: 'yellow',	radius: 695e6, },
		earth: 	{ name: 'earth',	color: 'blue',	 	radius: 6.3e6, },
		moon: 	{ name: 'moon',		color: 'white',	 	radius: 1.7e6, },
		mars: 	{ name: 'mars',		color: 'red',	 	radius: 3.4e6, },
	};
	var solar_system = new System({
		name: 'Solar System',
		motion: new Orbit({ 
			semi_major_axis: 2.35e20,
			effective_parent_mass: 1.22e53, // tons,  back calculated to achieve period of 250 million years
		}),
		body: bodies['sun'],
		children: [
			new System({
				name: 'Earth Orbit',
				motion: new Orbit({
					semi_major_axis: 1.*OrbitalMechanics.ASTRONOMICAL_UNIT,
					eccentricity: 0.0167,
					inclination: Math.PI * 5e-5/180,
					effective_parent_mass: 2e27, // tons
				}),	
				children: [

					new System({
						name: 'Lunar Orbit',
						motion: new Orbit({
							semi_major_axis: 384e6,
							eccentricity: 0.0554,
							inclination: Math.PI * 5.16/180,
							effective_parent_mass: 5.79e21, // tons
						}),	
						children: [
							new System({
								name: 'Lunar Spin',
								motion: new Spin({ 
									angular_speed: 2*Math.PI/(60*60*24*27.3),
									axial_tilt: 0,
								}),	
								body: bodies['moon'],
							}),
						],
					}),

					new System({
						name: 'Earth Spin',
						motion: new Spin({ 
							angular_speed: 2*Math.PI/(60*60*24),
							axial_tilt: Math.PI * 23.5/180,
						}),	
						body: bodies['earth'],
					}),
				],
			}),
			new System({
				name: 'Martian Orbit',
				motion: new Orbit({
					semi_major_axis: 1.52*OrbitalMechanics.ASTRONOMICAL_UNIT,
					eccentricity: 0.093,
					inclination: Math.PI * 1.85/180,
					effective_parent_mass: 2e27, // kg
				}),	
				children: [
					new System({
						name: 'Martian Day',
						motion: new Spin({ 
							angular_speed: 2*Math.PI/(60*60*24.6),
							axial_tilt: Math.PI * 25.19/180,
						}),	
						body: bodies['mars'],
					}),
				],
			}),
		]
	});


	var particleGeometry	= new THREE.Geometry();
    var particleShader = new THREE.ShaderMaterial({
        vertexShader: $('#particle-vertex-shader').text(),
        fragmentShader: $('#particle-fragment-shader').text(),
        attributes: {
        	radius:{
        		type: 'f',
        		value: []
        	},
        	color:{
        		type: 'c',
        		value: []
        	},
        },
        uniforms: {},
    });

	var solar_system_descendants = solar_system
			.descendants()
			.reduce((acc, x) => { acc[x.name] = x; return acc; }, {} )
	var body_matrix_map = solar_system_descendants['Earth Orbit'].get_body_matrices({
		'Lunar Orbit': Math.PI/5,
		'Earth Oribt': 0,
	})
	for (var id in body_matrix_map) {
		particleGeometry.vertices.push( new THREE.Vector3( ...Matrix4x4.get_translation(body_matrix_map[id]) ) );
		particleShader.attributes.color.value.push(new THREE.Color(bodies[id].color));
		particleShader.attributes.radius.value.push(bodies[id].radius);
	}
	var particleSystem = new THREE.ParticleSystem(particleGeometry, particleShader);

	if( Detector.webgl ){
		init();
		animate();
		update();
	} 

	// init the scene
	function init(){
		clock = new THREE.Clock();

		if( Detector.webgl ){
			renderer = new THREE.WebGLRenderer({
				antialias		: true,	// to get smoother output
				preserveDrawingBuffer	: true	// to allow screenshot
			});
			renderer.setClearColor( 0x000000 );
		}else{
			Detector.addGetWebGLMessage();
			return true;
		}
		var container = $("#container").get(0);
		renderer.setSize( window.innerWidth, window.innerHeight );
		$("#container").get(0).appendChild(renderer.domElement);

		renderStats = new Stats();
		$('#renderStats').append( renderStats.domElement );

		// create a scene
		scene = new THREE.Scene();

		// put a camera in the scene
		camera	= new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.01, 1e15 );
		camera.position.set(0, 0, 20);
		scene.add(camera);

		// create a camera contol
		controls	= new THREE.OrbitControls( camera, $("#container").get(0) );
		controls.noPan = false;
		controls.zoomSpeed = 5.0;
		
		// transparently support window resize
		THREEx.WindowResize.bind(renderer, camera);
		// allow 'p' to make screenshot
		// THREEx.Screenshot.bindKey(renderer);

		// here you add your objects
		// - you will most likely replace this part by your own
		var light	= new THREE.AmbientLight(  0xffffff );
		scene.add( light );
		scene.add( particleSystem );
		// scene.add( vectorField );
	}

	// animation loop
	function animate() {
		// push to render queue and loop
		// - it has to be at the begining of the function
		// - to learn more: https://www.youtube.com/watch?v=8aGhZQkoFbQ
		requestAnimationFrame( animate );

		// update camera controls
		controls.update();

		// actually render the scene
		renderer.render( scene, camera );

		renderStats.update();
	}

	function update(){
		
		//model.update();
		//view.cellUpdate(model.world()); 

	}

</script>
</body>
</html>
