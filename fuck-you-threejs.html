<!doctype html>
<html>
<head>
    <title>Tectonics.js - 3d plate tectonics in your web browser</title>
    <!--If using any IE, don't even bother-->
    <!--[if IE]>
        <meta http-equiv="refresh" content="0;url=ie.html" />
    <![endif]-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <link rel="icon" type="text/css" href="blog/icon6.png">
    <link rel="stylesheet" href="styles/bootstrap.min.css">
    <link rel="stylesheet" href="styles/main.css"/>
    <link rel="stylesheet" href="styles/app.css"/>

    <script src="libraries/vue.js"></script>
    <script src="libraries/Chart.js"></script>
    <script src="libraries/vue-charts.js"></script>
    <script src="libraries/bootstrap.bundle.min.js"></script>
    <script src="libraries/random-0.26.js"></script>
    <script src="libraries/base64-arraybuffer.js"></script>
    <script src="libraries/three.js/Three.js"></script>
    <script src="postcompiled/Shaders.js"></script>
    <script src="postcompiled/Rasters.js"></script>
    <script src="noncompiled/Units.js"></script>
    <script src="noncompiled/Interpolation.js"></script>
    <script src="noncompiled/Logging.js"></script>
    <!-- NOTE: we include scripts from the academic layer because it deals exclusively with rasters -->
    <script src="noncompiled/academics/SphericalGeometry.js"></script>
    <script src="noncompiled/academics/Optics.js"></script>
    <script src="noncompiled/academics/Thermodynamics.js"></script>
    <script src="noncompiled/academics/FluidMechanics.js"></script>
    <script src="noncompiled/academics/OrbitalMechanics.js"></script>
    <script src="noncompiled/academics/Tectonophysics.js"></script>
    <script src="noncompiled/academics/Hydrology.js"></script>
    <script src="noncompiled/academics/PlantBiology.js"></script>
    <script src="noncompiled/file-io/JsonSerializer.js"></script>
    <script src="noncompiled/controls/OrbitalControls.js"></script>
    <script src="noncompiled/controls/OrbitalController.js"></script>
    <script src="noncompiled/views/View.js"></script>
    <script src="noncompiled/views/ViewState.js"></script>
    <script src="noncompiled/views/ProgramUtils.js"></script>
    <script src="noncompiled/views/vector-rasters/VectorCloudProgram.js"></script>
    <script src="noncompiled/views/scalar-rasters/ColorscaleSurfacesProgram.js"></script>
</head>
<body>
<!-- WebGL container -->
<canvas id="gl" style="display: block; width: 100vw; height: 100vh"></canvas>

<script type="text/javascript">
    'use strict';

    // get WebGL context
    if( !window.WebGLRenderingContext ){ process.exit(1); }
    const gl_tag = document.getElementById("gl");
    const gl = gl_tag.getContext("webgl");
    if (!gl) { process.exit(1); }

    const RenderPassType = {
        Background: 'background',
        Solids: 'solids',
        Volumetrics: 'volumetrics',
        LensEffects: 'lens_effects'
    };
    const ProjectionType = {
        Perspective: 0,
        Equirectangular: 1,
    };

    const grid = new Grid(new THREE.IcosahedronGeometry(1, 5));
    var random = new Random();
    var demo = SphericalGeometry.get_random_surface_field(grid, random);

    const control_state = OrbitalControls.State({
        min_zoom_distance: 1.0,
        height: 5.0,
        angular_position: Vector2(0,Math.PI*30/180),
    });
    const view_state = {
        render_pass_type: RenderPassType.Solids,
        model_matrix: Matrix4x4.identity(),
        view_matrix: OrbitalControls.State.get_view_matrix(control_state),
        projection_matrix: 
            Matrix4x4.from_perspective(
                Math.PI*45/180, 
                gl.canvas.clientWidth/gl.canvas.clientHeight, 
                1e-3, 1e16
            ),
        projection_type: ProjectionType.Perspective,
    };
    const controls = new OrbitalController(
        control_state, 
        view_state.view_matrix,
        view_state.model_matrix
    );
    controls.addToDomElement(gl_tag);


    gl.enable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);


    let vector_cloud_program = new VectorCloudProgram(gl, view_state);
    let colorscale_surfaces_program = new ColorscaleSurfacesProgram(gl, view_state);
    const face_corner_color_values_storage = new Float32Array(grid._buffer_geometry_positions.length);
    const vector_raster_vertex_positions = new Float32Array([
        0,0,0, 0,0,1, 
        0,1,0, 1,0,0, 
        1,0,1, 1,1,0
    ]);
    const vector_raster_vector_fractions_traversed = new Float32Array([0,1, 0,1, 0,1]);

    // animation loop
    function animate() {
        // push to render queue and loop
        // - it has to be at the begining of the function
        // - to learn more: https://www.youtube.com/watch?v=8aGhZQkoFbQ
        requestAnimationFrame( animate );

        if (gl.canvas.width !== gl.canvas.clientWidth || gl.canvas.height !== gl.canvas.clientHeight) {
            gl.canvas.width = gl.canvas.clientWidth;
            gl.canvas.height = gl.canvas.clientHeight;
            gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
            view_state.projection_matrix = Matrix4x4.from_perspective(
                Math.PI*45/180, 
                gl.canvas.clientWidth/gl.canvas.clientHeight, 
                1e-3, 1e16
            );
        }

        gl.clearColor(0, 0, 0, 0);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        if (!colorscale_surfaces_program.canDepict(view_state)) {
            colorscale_surfaces_program.dispose();
            colorscale_surfaces_program = new ColorscaleSurfacesProgram(gl, view_state);
        }
        Float32Raster.get_ids(demo, demo.grid.buffer_array_to_cell, face_corner_color_values_storage); 
        colorscale_surfaces_program.draw(
            { 
                positions: grid._buffer_geometry_positions, 
                color_values: face_corner_color_values_storage
            }, 
            view_state,
        );
        vector_cloud_program.draw(
            {   
                positions: vector_raster_vertex_positions, 
                vector_fractions_traversed: vector_raster_vector_fractions_traversed,
            },
            view_state
        );
    }

    animate();
</script>
</body>
</html>
